/* =========================================================
   696 GAME — PVP CARD ANIMATIONS (SAFE)
   ---------------------------------------------------------
   Animation state classes are applied to .bb-slot in:
   app/pvp/battle/page.tsx

   PRINCIPLES:
   - Animate only containers (transform/opacity), never layout (no left/top).
   - CardArt remains an "atom".
   - FX lives in .bb-fx / pseudo-elements.
   ========================================================= */
   :root{
    /* tweak once — affects whole battle */
    --bb-ease-out: cubic-bezier(.18,.9,.22,1);
    --bb-ease-inout: cubic-bezier(.2,.0,.2,1);
    --bb-hit-ease: cubic-bezier(.2,.8,.2,1);
  
    /* tint for cheap grayscale particles (smoke/dust) */
    --bb-fx-tint-hue: 195deg;   /* blue/cyan */
    --bb-fx-tint-sat: 1.6;
    --bb-fx-tint-bright: 1.05;
    --bb-fx-shadow: 0 0 14px rgba(120, 220, 255, .35);
  }

/* === CARD BACK (so flip shows a real back, not transparency) === */
.bb-card-inner{ position: relative; transform-style: preserve-3d; }
.bb-face{ backface-visibility: hidden; -webkit-backface-visibility: hidden; }
.bb-face.bb-back{
  transform: rotateY(180deg);
  background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.08), rgba(0,0,0,0) 55%),
              linear-gradient(135deg, rgba(20,20,25,.98), rgba(5,5,8,.98));
  border: 1px solid rgba(255,255,255,.08);
}
.bb-face.bb-back .bb-mark{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-weight: 800;
  letter-spacing: .12em;
  opacity: .55;
  text-shadow: 0 6px 20px rgba(0,0,0,.65);
}

/* === Death: flip card to back and KEEP it (no fade-to-transparent) === */
.bb-slot.is-dying .bb-card{
  animation: bb_card_death_to_back 680ms var(--bb-ease-inout, cubic-bezier(.3,.7,.2,1)) both;
  transform-style: preserve-3d;
}
@keyframes bb_card_death_to_back{
  0%   { transform: translate3d(0,0,0) rotateY(0deg) scale(1); filter: saturate(1) brightness(1); }
  18%  { transform: translate3d(0,-2px,0) rotateY(0deg) scale(1.02); }
  45%  { transform: translate3d(0,6px,0) rotateY(70deg) scale(.96); filter: saturate(.8) brightness(.95); }
}

/* Vanish after death FX (stage 2). Keep minimal and avoid touching HUD/CardArt. */
.bb-slot.is-vanish .bb-card{
  animation: bb_card_vanish 240ms ease-out forwards !important;
}
@keyframes bb_card_vanish{
  0%   { opacity: 1; transform: translate3d(0,0,0) scale(.98); filter: saturate(.9) brightness(.95); }
  100% { opacity: 0; transform: translate3d(0,6px,0) scale(.90); filter: saturate(.6) brightness(.8); }
}

/* After unit is dead, force it to stay flipped (no transparency) */
.bb-card.is-dead{
  opacity: 1 !important;
}
.bb-card.is-dead .bb-card-inner{
  transform: rotateY(180deg) !important;
}



/* === FX LAYER (sibling of card, NOT clipped by CardArt overflow) === */
.bb-slot{ position: relative; overflow: visible; }
.bb-fx-layer{
  position: absolute;
  inset: -18px; /* let burst spill outside card */
  pointer-events: none;
  z-index: 50;
}
.bb-death{
  position: absolute;
  inset: 0;
  pointer-events: none;
}
.bb-slot.is-dying .bb-death::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: url("/fx/death_burst.png");
  background-repeat: no-repeat;
  background-position: 0 50%;
  background-size: auto 100%;
  transform: translateZ(0) scale(1.05);
  filter: contrast(1.15) brightness(1.1) saturate(1.1);
  opacity: 1;
  animation: bb_death_sprite 680ms steps(var(--bb-death-frames, 8)) both;
}
@keyframes bb_death_sprite{
  from { background-position: 0 50%; opacity: 1; }
  to   { background-position: 100% 50%; opacity: 0; }
}


  
  
/* STEP A FIX: ensure FX layer is above bb-overlay (page.tsx sets .bb-fx z-index:6) */
.bb-fx{ z-index: 12 !important; }

/* Base safety */
  .bb-slot{
    will-change: transform, opacity;
    transform-origin: 50% 70%;
  }
  
  /* =========================================================
     STEP 1 — SPAWN
     ========================================================= */
  .bb-slot.is-spawn{
    animation: bb_spawn 420ms var(--bb-ease-out) both;
    filter: saturate(1.02);
  }
  @keyframes bb_spawn{
    0%   { opacity: 0; transform: translate3d(0,18px,0) scale(.92); }
    55%  { opacity: 1; transform: translate3d(0,-2px,0) scale(1.02); }
    100% { opacity: 1; transform: translate3d(0,0,0)  scale(1); }
  }
  
  /* =========================================================
     STEP 2 — HIT / DAMAGE
     ========================================================= */
  .bb-slot.is-damage{
    animation: bb_hit_shake 140ms var(--bb-hit-ease) both;
  }
  @keyframes bb_hit_shake{
    0%   { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
    25%  { transform: translate3d(-2px,0,0) rotate(-0.6deg) scale(.995); }
    55%  { transform: translate3d( 2px,0,0) rotate( 0.6deg) scale(.995); }
  }
  
  /* a clean flash overlay — cheap, but reads well */
  .bb-slot.is-damage::after{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius: 14px;
    pointer-events:none;
    background: radial-gradient(closest-side, rgba(255,80,80,.35), rgba(255,80,80,0) 70%);
    mix-blend-mode: screen;
    opacity:0;
    animation: bb_hit_flash 160ms var(--bb-ease-out) both;
  }
  @keyframes bb_hit_flash{
    0%{ opacity:0; transform: scale(.96); }
    45%{ opacity:1; transform: scale(1.02); }
    100%{ opacity:0; transform: scale(1.06); }
  }
  
  /* =========================================================
     STEP 3 — ATTACK LUNGE
     .is-attack-from  => attacker lunges forward
     .is-attack-to    => victim gets tiny recoil + impact flash
     ========================================================= */
  .bb-slot.is-attack-from{
    animation: bb_attack_lunge 240ms var(--bb-ease-out) both;
  }
  @keyframes bb_attack_lunge{
    0%   { transform: translate3d(0,0,0) scale(1); }
    55%  { transform: translate3d(0,-10px,0) scale(1.03); } /* up = toward center in our vertical arena */
    100% { transform: translate3d(0,0,0) scale(1); }
  }
  
  .bb-slot.is-attack-to{
    animation: bb_attack_recoil 220ms var(--bb-ease-out) both;
  }
  @keyframes bb_attack_recoil{
    0%   { transform: translate3d(0,0,0) scale(1); }
    45%  { transform: translate3d(0,6px,0) scale(.99); }
    100% { transform: translate3d(0,0,0) scale(1); }
  }
  
  /* =========================================================
     STEP 4A — DEATH (Collapse + Ash) — NO ASSET REQUIRED
     ========================================================= */
  .bb-slot.is-dying{
    animation: bb_death_collapse 680ms var(--bb-ease-inout) both;
    filter: saturate(.35) brightness(.92) contrast(1.05);
  }


  /* ash overlay */
  .bb-slot.is-dying::before{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius: 14px;
    pointer-events:none;
  
    background:
      radial-gradient(closest-side, rgba(210,210,210,.22), rgba(210,210,210,0) 65%),
      radial-gradient(closest-side, rgba(120,220,255,.10), rgba(120,220,255,0) 70%);
  
    mix-blend-mode: screen;
    opacity:0;
    animation: bb_ash 680ms var(--bb-ease-inout) both;
    filter: hue-rotate(var(--bb-fx-tint-hue)) saturate(var(--bb-fx-tint-sat)) brightness(var(--bb-fx-tint-bright));
  }
  @keyframes bb_ash{
    0%{ opacity:0; transform: scale(.98); }
    30%{ opacity:.55; transform: scale(1.02); }
    100%{ opacity:0; transform: scale(1.12); }
  }
  
  @keyframes bb_death_collapse{
    0%   { opacity:1; transform: translate3d(0,0,0) rotate(0deg) scale(1); }
    18%  { opacity:1; transform: translate3d(0,0,0) rotate(-1.2deg) scale(1.01); } /* micro-freeze + tilt */
    55%  { opacity:.92; transform: translate3d(0,16px,0) rotate(3.5deg) scale(.92); } /* drop + squash */
  }
  
  /* =========================================================
     STEP 4B — OPTIONAL SPRITE POP (death_burst.png)
     Put sprite here: public/fx/death_burst.png
  
     Expected:
     - 8 frames in a row (horizontal)
     - each frame square (e.g. 256x256)
     ========================================================= */
  .bb-slot.is-dying .bb-death{
    position:absolute;
    inset:-10px;
    pointer-events:none;
    border-radius: 16px;
    opacity:1;
    z-index: 10;
  }
  
  /* sprite layer */
  .bb-slot.is-dying .bb-death::before{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    width: 320px;
    height: 320px;
    transform: translate(-50%,-55%);
    background-image: url("/fx/death_burst.png");
    background-repeat: no-repeat;
    background-size: 800% 100%;
    image-rendering: auto;
  
    /* make grayscale look "alive" */
    filter:
      hue-rotate(var(--bb-fx-tint-hue))
      saturate(var(--bb-fx-tint-sat))
      brightness(var(--bb-fx-tint-bright))
      drop-shadow(var(--bb-fx-shadow));
  
    opacity:1;
    mix-blend-mode: screen;
    animation: bb_sprite8 680ms steps(8) both;
  }
  
  /* glow halo behind sprite */
  .bb-slot.is-dying .bb-death::after{
    content:"";
    position:absolute;
    inset:0;
    background: radial-gradient(circle at 50% 50%, rgba(120,220,255,.26), rgba(120,220,255,0) 65%);
    mix-blend-mode: screen;
    opacity:0;
    animation: bb_halo 520ms var(--bb-ease-out) both;
    pointer-events:none;
  }
  
  @keyframes bb_sprite8{
    from { background-position:   0% 50%; }
    to   { background-position: 100% 50%; }
  }
  @keyframes bb_halo{
    0%{ opacity:0; transform: scale(.9); }
    25%{ opacity:.75; transform: scale(1.02); }
    100%{ opacity:0; transform: scale(1.18); }
  }
  
  /* keep it safe on low-end devices */
  @media (prefers-reduced-motion: reduce){
    .bb-slot.is-spawn,
    .bb-slot.is-damage,
    .bb-slot.is-attack-from,
    .bb-slot.is-attack-to,
    .bb-slot.is-dying{ animation: none !important; }
    .bb-slot.is-damage::after,
    .bb-slot.is-dying::before,
    .bb-slot.is-dying .bb-death::before,
    .bb-slot.is-dying .bb-death::after{ animation: none !important; opacity: 0 !important; }
  }


/* STEP D: Real death FX (sprite) anchored to each card slot */
.bb-slot{ position: relative; }
.bb-fx-anchor{
  position:absolute;
  inset:0;
  z-index: 80;
  pointer-events:none;
  overflow: visible;
}

/* Sprite burst: expects /public/fx/retro/death_burst.png (horizontal strip, 8 frames) */
.bb-death{
  position:absolute;
  left:50%;
  top:50%;
  width: 190%;
  height: 190%;
  transform: translate(-50%, -50%);
  background-image: url("/fx/retro/death_burst.png");
  background-repeat: no-repeat;
  background-position: 0% 50%;
  background-size: 800% 100%; /* 8 frames horizontally */
  opacity: 1;
  filter: drop-shadow(0 0 10px rgba(0,0,0,0.55));
  will-change: background-position, transform, opacity;
  animation: bbDeathSprite 900ms steps(8) forwards;
}

/* Optional: small punch so it feels like HS */
.bb-slot.is-dying .bb-card{
  animation: bbDeathPunch 240ms ease-out;
}

@keyframes bbDeathPunch{
  0%{ transform: translateZ(0) scale(1); }
  60%{ transform: translateZ(0) scale(1.06); }
  100%{ transform: translateZ(0) scale(1); }
}

@keyframes bbDeathSprite{
  from{ background-position: 0% 50%; opacity:1; }
  to{ background-position: 100% 50%; opacity:0; }
}



/* =========================================================
   FX MANAGER (GUARANTEED) — DEATH BURST ATLAS STRIP (3 frames, padded)
   ---------------------------------------------------------------
   This layer is independent from card DOM (opacity/filter/overflow).

   Asset:
   - Place file at: /public/fx/retro/death_burst_strip.png
   - Served as:     /fx/retro/death_burst_strip.png
   - Current strip size (native): 194 x 59
   - Frames are NOT evenly tiled; we use explicit background offsets.

   NOTE:
   page.tsx passes CSS var --bb-strip-scale = (burstSize / 59)
========================================================= */

.bb-fx-layer{
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
}

.bb-fx-burst{
  position: absolute;
  transform: translate(-50%, -50%);
  overflow: hidden;
  pointer-events: none;
  will-change: transform, opacity;
}

/* Death burst driven by background offsets (no bleeding, no steps strip-move) */
.bb-fx-burst__atlas{
  position: absolute;
  inset: 0;
  background-image: url("/fx/retro/death_burst_strip.png");
  background-repeat: no-repeat;
  background-position: 0px 50%;
  /* scale native strip using var from page.tsx */
  background-size:
    calc(194px * var(--bb-strip-scale, 2))
    calc(59px  * var(--bb-strip-scale, 2));
  will-change: background-position, transform, opacity;
  opacity: 1;
}

.bb-fx-burst--death{
  opacity: 1;
  animation: bb-death-pop 560ms ease-out forwards;
}

.bb-fx-burst--death .bb-fx-burst__atlas{
  animation: bb-death-atlas-3 520ms linear forwards;
}

/* Frame centers (native, px):
   F1 center ≈ 31px  => bgX ≈ -2px
   F2 center ≈ 95.5  => bgX ≈ -66px
   F3 center ≈ 159.5 => bgX ≈ -130px
   Multiply by --bb-strip-scale so it stays correct at any size.
*/
@keyframes bb-death-atlas-3{
  /* Hold each frame so it DOESN'T "slide left" between positions */
  0%, 32.9%  { background-position: calc(-2px   * var(--bb-strip-scale, 2)) 50%; opacity: 1; }
  33%, 65.9% { background-position: calc(-66px  * var(--bb-strip-scale, 2)) 50%; opacity: 1; }
  66%, 92.9% { background-position: calc(-130px * var(--bb-strip-scale, 2)) 50%; opacity: 1; }
  100%       { background-position: calc(-130px * var(--bb-strip-scale, 2)) 50%; opacity: 0; }
}

@keyframes bb-death-pop{
  0%{ transform: translate(-50%, -52%) scale(0.92); opacity: 0; }
  8%{ opacity: 1; }
  70%{ opacity: 1; }
  100%{ transform: translate(-50%, -52%) scale(1.06); opacity: 0; }
}
