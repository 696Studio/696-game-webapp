/* =========================================================
   696 GAME â€” PVP CARD ANIMATIONS (SAFE)
   ---------------------------------------------------------
   Animation state classes are applied to .bb-slot in:
   app/pvp/battle/page.tsx

   PRINCIPLES:
   - Animate only containers (transform/opacity), never layout (no left/top).
   - CardArt remains an "atom".
   - FX lives in .bb-fx / pseudo-elements.
   ========================================================= */
   :root{
    /* tweak once â€” affects whole battle */
    --bb-ease-out: cubic-bezier(.18,.9,.22,1);
    --bb-ease-inout: cubic-bezier(.2,.0,.2,1);
    --bb-hit-ease: cubic-bezier(.2,.8,.2,1);
  
    /* tint for cheap grayscale particles (smoke/dust) */
    --bb-fx-tint-hue: 195deg;   /* blue/cyan */
    --bb-fx-tint-sat: 1.6;
    --bb-fx-tint-bright: 1.05;
    --bb-fx-shadow: 0 0 14px rgba(120, 220, 255, .35);
  }

/* === CARD BACK (so flip shows a real back, not transparency) === */
.bb-card-inner{ position: relative; transform-style: preserve-3d; }
.bb-face{ backface-visibility: hidden; -webkit-backface-visibility: hidden; }
.bb-face.bb-back{
  transform: rotateY(180deg);
  background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.08), rgba(0,0,0,0) 55%),
              linear-gradient(135deg, rgba(20,20,25,.98), rgba(5,5,8,.98));
  border: 1px solid rgba(255,255,255,.08);
}
.bb-face.bb-back .bb-mark{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-weight: 800;
  letter-spacing: .12em;
  opacity: .55;
  text-shadow: 0 6px 20px rgba(0,0,0,.65);
}

/* === Death: flip card to back and KEEP it (no fade-to-transparent) === */
.bb-slot.is-dying .bb-card{
  animation: bb_card_death_to_back 680ms var(--bb-ease-inout, cubic-bezier(.3,.7,.2,1)) both;
  transform-style: preserve-3d;
}
/* Vanish after death (separate, does NOT affect FX Manager) */
.bb-slot.is-dying.is-vanish .bb-card,
.bb-slot.is-vanish .bb-card{
  animation:
    bb_card_death_to_back 680ms var(--bb-ease-inout, cubic-bezier(.3,.7,.2,1)) both,
    bb_card_vanish 260ms cubic-bezier(.2,.9,.2,1) forwards;
  animation-delay: 0ms, 520ms;
  transform-style: preserve-3d;
}

@keyframes bb_card_vanish{
  0%   { opacity: 1; transform: translate3d(0,0,0) scale(1); filter: none; }
  100% { opacity: 0; transform: translate3d(0,18px,0) scale(.84); filter: blur(1.2px) brightness(.92); }
}


@keyframes bb_card_death_to_back{
  0%   { transform: translate3d(0,0,0) rotateY(0deg) scale(1); filter: saturate(1) brightness(1); }
  18%  { transform: translate3d(0,-2px,0) rotateY(0deg) scale(1.02); }
  45%  { transform: translate3d(0,6px,0) rotateY(70deg) scale(.96); filter: saturate(.8) brightness(.95); }
}

/* After unit is dead, force it to stay flipped (no transparency) */
.bb-card.is-dead{
  opacity: 1 !important;
}
.bb-card.is-dead .bb-card-inner{
  transform: rotateY(180deg) !important;
}



/* === FX LAYER (sibling of card, NOT clipped by CardArt overflow) === */
.bb-slot{ position: relative; overflow: visible; }
.bb-fx-layer{
  position: absolute;
  inset: -18px; /* let burst spill outside card */
  pointer-events: none;
  z-index: 50;
}
/* --- Death FX (atlas-style): no sliding, no bleeding ---
   Asset: /fx/retro/death_burst_strip.png (194x59) â€” 3 frames with padding.
   We animate background-position with HOLD segments to avoid interpolation "sliding left".
*/
.bb-fx-burst--death .bb-fx-burst__atlas{
  width: 100%;
  height: 100%;
  background-image: url("/fx/retro/death_burst_strip.png");
  background-repeat: no-repeat;
  background-size: calc(194px * var(--bb-strip-scale, 2)) calc(59px * var(--bb-strip-scale, 2));
  background-position: calc(-2px * var(--bb-strip-scale, 2)) 50%;
  will-change: background-position, opacity;
  image-rendering: auto;
  animation: bb-death-atlas-3 520ms linear forwards;
}

/* If old strip-based img exists somewhere, don't animate it for death */
.bb-fx-burst--death .bb-fx-burst__img{
  animation: none !important;
}

@keyframes bb-death-atlas-3{
  /* Hold each frame â€” no in-between positions */
  0%, 32.9%  { background-position: calc(-2px   * var(--bb-strip-scale, 2)) 50%; opacity: 1; }
  33%, 65.9% { background-position: calc(-66px  * var(--bb-strip-scale, 2)) 50%; opacity: 1; }
  66%, 92.9% { background-position: calc(-130px * var(--bb-strip-scale, 2)) 50%; opacity: 1; }
  100%       { background-position: calc(-130px * var(--bb-strip-scale, 2)) 50%; opacity: 0; }
}

.bb-death{
  position: absolute;
  inset: 0;
  pointer-events: none;
}
.bb-slot.is-dying .bb-death::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: url("/fx/retro/death_burst_strip.png");
  background-repeat: no-repeat;
  /* strip frame size: 194x59, we scale via CSS var */
  background-size: calc(194px * var(--bb-strip-scale, 2)) calc(59px * var(--bb-strip-scale, 2));
  /* slight left padding inside strip */
  background-position: calc(-2px * var(--bb-strip-scale, 2)) 50%;
  transform: translateZ(0) scale(1.05);
  filter: contrast(1.15) brightness(1.1) saturate(1.1);
  opacity: 1;
  /* use same working animation as FxLayer */
  animation: bb-death-atlas-3 520ms linear forwards;
}

@keyframes bb_death_sprite{
  from { background-position: 0 50%; opacity: 1; }
  to   { background-position: 100% 50%; opacity: 0; }
}


  
  
/* STEP A FIX: ensure FX layer is above bb-overlay (page.tsx sets .bb-fx z-index:6) */
.bb-fx{ z-index: 12 !important; }

/* Base safety */
  .bb-slot{
    will-change: transform, opacity;
    transform-origin: 50% 70%;
  }
  
  /* =========================================================
     STEP 1 â€” SPAWN
     ========================================================= */
  .bb-slot.is-spawn{
    animation: bb_spawn 420ms var(--bb-ease-out) both;
    filter: saturate(1.02);
  }
  @keyframes bb_spawn{
    0%   { opacity: 0; transform: translate3d(0,18px,0) scale(.92); }
    55%  { opacity: 1; transform: translate3d(0,-2px,0) scale(1.02); }
    100% { opacity: 1; transform: translate3d(0,0,0)  scale(1); }
  }
  
  /* =========================================================
     STEP 2 â€” HIT / DAMAGE
     ========================================================= */
  .bb-slot.is-damage{
    animation: bb_hit_shake 140ms var(--bb-hit-ease) both;
  }
  @keyframes bb_hit_shake{
    0%   { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
    25%  { transform: translate3d(-2px,0,0) rotate(-0.6deg) scale(.995); }
    55%  { transform: translate3d( 2px,0,0) rotate( 0.6deg) scale(.995); }
  }
  
  /* a clean flash overlay â€” cheap, but reads well */
  .bb-slot.is-damage::after{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius: 14px;
    pointer-events:none;
    background: radial-gradient(closest-side, rgba(255,80,80,.35), rgba(255,80,80,0) 70%);
    mix-blend-mode: screen;
    opacity:0;
    animation: bb_hit_flash 160ms var(--bb-ease-out) both;
  }
  @keyframes bb_hit_flash{
    0%{ opacity:0; transform: scale(.96); }
    45%{ opacity:1; transform: scale(1.02); }
    100%{ opacity:0; transform: scale(1.06); }
  }
  
  /* =========================================================
     STEP 3 â€” ATTACK LUNGE
     .is-attack-from  => attacker lunges forward
     .is-attack-to    => victim gets tiny recoil + impact flash
     ========================================================= */
  .bb-slot.is-attack-from{
    animation: bb_attack_lunge 240ms var(--bb-ease-out) both;
  }
  @keyframes bb_attack_lunge{
    0%   { transform: translate3d(0,0,0) scale(1); }
    55%  { transform: translate3d(0,-10px,0) scale(1.03); } /* up = toward center in our vertical arena */
    100% { transform: translate3d(0,0,0) scale(1); }
  }
  
  .bb-slot.is-attack-to{
    animation: bb_attack_recoil 220ms var(--bb-ease-out) both;
  }
  @keyframes bb_attack_recoil{
    0%   { transform: translate3d(0,0,0) scale(1); }
    45%  { transform: translate3d(0,6px,0) scale(.99); }
    100% { transform: translate3d(0,0,0) scale(1); }
  }
  
  /* =========================================================
     STEP 4A â€” DEATH (Collapse + Ash) â€” NO ASSET REQUIRED
     ========================================================= */
  .bb-slot.is-dying{
    animation: bb_death_collapse 680ms var(--bb-ease-inout) both;
    filter: saturate(.35) brightness(.92) contrast(1.05);
  }


  /* ash overlay */
  .bb-slot.is-dying::before{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius: 14px;
    pointer-events:none;
  
    background:
      radial-gradient(closest-side, rgba(210,210,210,.22), rgba(210,210,210,0) 65%),
      radial-gradient(closest-side, rgba(120,220,255,.10), rgba(120,220,255,0) 70%);
  
    mix-blend-mode: screen;
    opacity:0;
    animation: bb_ash 680ms var(--bb-ease-inout) both;
    filter: hue-rotate(var(--bb-fx-tint-hue)) saturate(var(--bb-fx-tint-sat)) brightness(var(--bb-fx-tint-bright));
  }
  @keyframes bb_ash{
    0%{ opacity:0; transform: scale(.98); }
    30%{ opacity:.55; transform: scale(1.02); }
    100%{ opacity:0; transform: scale(1.12); }
  }
  
  @keyframes bb_death_collapse{
    0%   { opacity:1; transform: translate3d(0,0,0) rotate(0deg) scale(1); }
    18%  { opacity:1; transform: translate3d(0,0,0) rotate(-1.2deg) scale(1.01); } /* micro-freeze + tilt */
    55%  { opacity:.92; transform: translate3d(0,16px,0) rotate(3.5deg) scale(.92); } /* drop + squash */
    100% { opacity:1; transform: translate3d(0,26px,0) rotate(6deg) scale(.85); }
  }
  
  /* =========================================================
     STEP 4B â€” OPTIONAL SPRITE POP (death_burst.png)
     Put sprite here: public/fx/death_burst.png
  
     Expected:
     - 8 frames in a row (horizontal)
     - each frame square (e.g. 256x256)
     ========================================================= */
  .bb-slot.is-dying .bb-death{
    position:absolute;
    inset:-10px;
    pointer-events:none;
    border-radius: 16px;
    opacity:1;
    z-index: 10;
  }
  
  /* sprite layer */
  .bb-slot.is-dying .bb-death::before{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    width: 320px;
    height: 320px;
    transform: translate(-50%,-55%);

    background-image: url("/fx/retro/death_burst_strip.png");
    background-repeat: no-repeat;
    background-size: calc(194px * var(--bb-strip-scale, 2)) calc(59px * var(--bb-strip-scale, 2));
    background-position: calc(-2px * var(--bb-strip-scale, 2)) 50%;
    image-rendering: auto;

    /* make grayscale look "alive" */
    filter:
      hue-rotate(var(--bb-fx-tint-hue))
      saturate(var(--bb-fx-tint-sat))
      brightness(var(--bb-fx-tint-bright))
      drop-shadow(var(--bb-fx-shadow));

    opacity:1;
    mix-blend-mode: screen;
    animation: bb-death-atlas-3 520ms linear forwards;
}

  
  /* glow halo behind sprite */
  .bb-slot.is-dying .bb-death::after{
    content:"";
    position:absolute;
    inset:0;
    background: radial-gradient(circle at 50% 50%, rgba(120,220,255,.26), rgba(120,220,255,0) 65%);
    mix-blend-mode: screen;
    opacity:0;
    animation: bb_halo 520ms var(--bb-ease-out) both;
    pointer-events:none;
  }
  
  @keyframes bb_sprite8{
    from { background-position:   0% 50%; }
    to   { background-position: 100% 50%; }
  }
  @keyframes bb_halo{
    0%{ opacity:0; transform: scale(.9); }
    25%{ opacity:.75; transform: scale(1.02); }
    100%{ opacity:0; transform: scale(1.18); }
  }
  
  /* keep it safe on low-end devices */
  @media (prefers-reduced-motion: reduce){
    .bb-slot.is-spawn,
    .bb-slot.is-damage,
    .bb-slot.is-attack-from,
    .bb-slot.is-attack-to,
    .bb-slot.is-dying{ animation: none !important; }
    .bb-slot.is-damage::after,
    .bb-slot.is-dying::before,
    .bb-slot.is-dying .bb-death::before,
    .bb-slot.is-dying .bb-death::after{ animation: none !important; opacity: 0 !important; }
  }


/* STEP D: Real death FX (sprite) anchored to each card slot */
.bb-slot{ position: relative; }
.bb-fx-anchor{
  position:absolute;
  inset:0;
  z-index: 80;
  pointer-events:none;
  overflow: visible;
}

/* Sprite burst: expects /public/fx/retro/death_burst.png (horizontal strip, 8 frames) */
.bb-death{
  position:absolute;
  left:50%;
  top:50%;
  width: 190%;
  height: 190%;
  transform: translate(-50%, -50%);
  background-image: url("/fx/retro/death_burst.png");
  background-repeat: no-repeat;
  background-position: 0% 50%;
  background-size: 800% 100%; /* 8 frames horizontally */
  opacity: 1;
  filter: drop-shadow(0 0 10px rgba(0,0,0,0.55));
  will-change: background-position, transform, opacity;
  animation: bbDeathSprite 900ms steps(8) forwards;
}

/* Optional: small punch so it feels like HS */
.bb-slot.is-dying .bb-card{
  animation: bbDeathPunch 240ms ease-out;
}

@keyframes bbDeathPunch{
  0%{ transform: translateZ(0) scale(1); }
  60%{ transform: translateZ(0) scale(1.06); }
  100%{ transform: translateZ(0) scale(1); }
}

@keyframes bbDeathSprite{
  from{ background-position: 0% 50%; opacity:1; }
  to{ background-position: 100% 50%; opacity:0; }
}



/* =========================================================
   FX MANAGER (GUARANTEED) â€” DEATH BURST STRIP
   This layer is independent from card DOM (opacity/filter/overflow).
   Asset must exist at: /public/fx/retro/death_burst_strip.png
   Served as: /fx/retro/death_burst_strip.png
========================================================= */

.bb-fx-layer{
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
}

.bb-fx-burst{
  position: absolute;
  transform: translate(-50%, -50%);
  overflow: hidden;
  pointer-events: none;
  /* keep it crisp and prevent edge sampling artifacts */
  image-rendering: auto;
  will-change: transform, opacity;
}

.bb-fx-burst__img{
  height: 100%;
  width: 400%;
  max-width: none;
  display: block;
  transform: translateX(0);
  will-change: transform;
}

.bb-fx-burst--death{
  opacity: 1;
  animation: bb-death-pop 560ms ease-out forwards;
}

.bb-fx-burst--death .bb-fx-burst__img{
  animation: bb-strip-move 520ms steps(4) forwards;
}

@keyframes bb-strip-move{
  from{ transform: translateX(0); }
  /* 4 frames => move left by 3/4 of the strip width */
  to{ transform: translateX(-75%); }
}

@keyframes bb-death-pop{
  0%{ transform: translate(-50%, -52%) scale(0.92); opacity: 0; }
  8%{ opacity: 1; }
  70%{ opacity: 1; }
  100%{ transform: translate(-50%, -52%) scale(1.06); opacity: 0; }
}


/* Vanish: when the card is removed from render, keep slot layout but hide visuals */
.bb-slot.is-hidden{ opacity:0; pointer-events:none; }


/* =========================================================
   DEATH + VANISH (FINAL OVERRIDE)
   Goal:
   - Keep current death burst FX working
   - Flip card to back (gamey) then vanish and remove
   - Prevent earlier partial keyframes from breaking the flip
========================================================= */

@keyframes bb_card_death_to_back__final{
  0%   { transform: translate3d(0,0,0) rotateY(0deg) scale(1); filter: saturate(1) brightness(1); }
  18%  { transform: translate3d(0,-2px,0) rotateY(0deg) scale(1.02); }
  45%  { transform: translate3d(0,6px,0) rotateY(70deg) scale(.96); filter: saturate(.85) brightness(.96); }
  100% { transform: translate3d(0,10px,0) rotateY(180deg) scale(.92); filter: saturate(.75) brightness(.92); }
}

@keyframes bb_card_vanish__final{
  0%   { opacity: 1; transform: translate3d(0,10px,0) rotateY(180deg) scale(.92); filter: saturate(.75) brightness(.92); }
  100% { opacity: 0; transform: translate3d(0,26px,0) rotateY(180deg) scale(.82); filter: blur(1.2px) brightness(.88); }
}

/* Triggered by CardSlot: .bb-slot.is-dying and .bb-slot.is-vanish */
.bb-slot.is-dying .bb-card{
  animation: bb_card_death_to_back__final 680ms var(--bb-ease-inout, cubic-bezier(.3,.7,.2,1)) both !important;
  transform-style: preserve-3d;
}

.bb-slot.is-dying.is-vanish .bb-card,
.bb-slot.is-vanish .bb-card{
  animation:
    bb_card_death_to_back__final 680ms var(--bb-ease-inout, cubic-bezier(.3,.7,.2,1)) both,
    bb_card_vanish__final 260ms cubic-bezier(.2,.9,.2,1) forwards !important;
  animation-delay: 0ms, 520ms;
  transform-style: preserve-3d;
}

/* When the unit is flagged dead, do NOT fade it by old rules */
.bb-card.is-dead{
  opacity: 1 !important;
  filter: none !important;
}

/* Keep the slot footprint but fully hide once CardSlot sets isHidden=true */
.bb-slot.is-hidden{
  opacity: 0 !important;
  pointer-events: none !important;
}



/* Safety: don't dim dead cards; vanish handles removal */
.bb-card.has-unit.is-dead{opacity:1 !important; filter:none !important;}


/* ================================
   Death â†’ Vanish â†’ Remove (stable)
   ================================ */
.bb-slot.is-hidden {
  opacity: 0 !important;
  visibility: hidden !important;
  pointer-events: none !important;
}
.bb-slot.is-hidden .bb-card {
  display: none !important;
}



/* =========================================================
   FINAL DEAD STATE â€” SKELETON OVERLAY (STABLE)
   Uses existing .is-dead flag. Does NOT affect death animation.
   Asset: /public/fx/dead_skeleton.png
   ========================================================= */

.bb-card.is-dead{
  opacity: 1 !important;
  filter: none !important;
  pointer-events: none;
  position: relative;
}

.bb-card.is-dead::after{
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 20;
}

.bb-card.is-dead::before{
  content: "";
  position: absolute;
  inset: 0;
  background: url("/fx/dead_skeleton.png") center / 60% no-repeat;
  opacity: .95;
  z-index: 21;
}

/* =========================================================
   ðŸ”’ DEAD STATE OVERRIDES (FINAL, MINIMAL, SAFE)
   PURPOSE:
   - Card stays visible after death
   - Slot never fades to opacity:0 for dead cards
   - Skeleton PNG is always visible
   ========================================================= */

/* NEVER hide slot if card is dead */
.bb-slot.is-dying:has(.bb-card.is-dead),
.bb-slot.is-hidden:has(.bb-card.is-dead){
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: none !important;
}

/* Ensure dead card is fully visible */
.bb-card.is-dead{
  opacity: 1 !important;
  visibility: visible !important;
  display: block !important;
  pointer-events: none !important;
  position: relative !important;
}

/* Dark overlay */
.bb-card.is-dead::after{
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 200;
  pointer-events: none;
}

/* Skeleton overlay */
.bb-card.is-dead::before{
  content: "";
  position: absolute;
  inset: 0;
  background: url("/fx/dead_skeleton.png") center / 60% no-repeat;
  opacity: 1;
  z-index: 201;
  pointer-events: none;
}

/* =========================================================
   DEAD STATE â€” MINIMAL SAFE FIX (DO NOT REMOVE)
   ========================================================= */

/* Dead card must stay visible */
.bb-card.is-dead{
  opacity: 1 !important;
  visibility: visible !important;
  display: block !important;
  pointer-events: none !important;
  position: relative !important;
}

/* Darken dead card */
.bb-card.is-dead::after{
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 200;
  pointer-events: none;
}

/* Skeleton overlay */
.bb-card.is-dead::before{
  content: "";
  position: absolute;
  inset: 0;
  background: url("/fx/dead_skeleton.png") center / 60% no-repeat;
  opacity: 1;
  z-index: 201;
  pointer-events: none;
}

/* If slot becomes hidden, keep dead card visible */
.bb-slot.is-hidden .bb-card.is-dead{
  display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
}
